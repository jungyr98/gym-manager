<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "file:///D:/eclipse-workspace/gym-manager-backend/src/main/resources/mybatis-3-mapper.dtd" >
<mapper namespace="com.potato.member.list.mapper.MemberMapper">

	<!-- 검색 조건 -->
	<sql id="search">
		WM.wp_seq = #{wpSeq}
		<if test="memberName != null and !memberName.isEmpty()">
			and WM.member_name like concat('%', lower(trim(#{memberName})) , '%')
		</if>
		<if test="memberPhone != null and !memberPhone.isEmpty()">
			and WM.member_phone like concat('%', lower(trim(#{memberPhone})) , '%')
		</if>
		<if test="memberSex != null and !memberSex.isEmpty()">
			and WM.member_sex = #{memberSex}
		</if>
	</sql>

	<!-- 목록 개수 조회 -->
	<select id="getListCnt" resultType="Integer">
		select count(*)
		from workplace_member WM
		<where>
			<include refid="search" />
		</where>
	</select>

	<!-- 목록 조회 -->
	<select id="selectList" resultType="com.potato.member.list.vo.MemberVO">
		select WM.member_name
			 , WM.wp_seq
			 , WM.member_birth
			 , WM.member_addr
			 , WM.member_phone
			 , WM.member_seq
			 , WM.member_sex
			 , WM.reg_date
			 , PH.reg_date as start_date
	 		 , date_add(PH.reg_date, INTERVAL MS.membership_period MONTH) as end_date
		from workplace_member WM
		left join (
			select row_number() over(partition by member_seq order by reg_date desc) as row_num
				 , member_seq
				 , member_name
                 , membership_seq
				 , reg_date
			from payments_history
        	) PH on PH.member_seq = WM.member_seq and PH.row_num = 1
		left join membership MS on MS.membership_seq = PH.membership_seq
		<where>
			<include refid="search" />
			<if test="activeYn != null and !activeYn.isEmpty()">
				<choose>
					<when test='activeYn.equals("N")'>
						and PH.reg_date is null
					</when>
					<otherwise>
						and PH.reg_date is not null
					</otherwise>
				</choose>
			</if>
		</where>
		order by WM.member_seq desc
		<include refid="com.potato.core.common.mapper.CommonMapper.queryForPagingFooter" />
	</select>

	<!-- 휴대폰 뒷자리로 회원 조회 -->
	<select id="selectPhoneNumber" resultType="com.potato.member.list.vo.MemberVO">
		select *
        from workplace_member
        where right(member_phone, 4) = #{lastPhoneNumber}
	</select>

	<!-- 이번주 새로 등록된 회원 조회 -->
	<select id="selectWeekList" resultType="com.potato.member.list.vo.MemberVO">
		select *
		from workplace_member
		where date_format(reg_date, '%Y-%m-%d')
			between (SELECT ADDDATE(CURDATE(), - WEEKDAY(CURDATE()) + 0 ))
			AND (SELECT ADDDATE(CURDATE(), - WEEKDAY(CURDATE()) + 6 ))
		order by reg_date desc
	</select>


</mapper>